<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus AI</title>
    <link rel="icon" href="{{ url_for('static', filename='icon.png') }}" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-top">
            <button class="action-btn new-chat" onclick="startNewChat()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14" />
                </svg>
                New Chat
            </button>
        </div>

        <div class="section-label">Today</div>
        <div class="chat-list" id="chatList">
            <!-- Dynamic Chats -->
        </div>

        <div style="margin-top: auto;">
            <button class="action-btn" style="width: 100%;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 15a3 3 0 100-6 3 3 0 000 6z" />
                    <path
                        d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z" />
                </svg>
                Settings
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <button class="menu-icon" onclick="toggleSidebar()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                    <line x1="9" y1="3" x2="9" y2="21" />
                </svg>
            </button>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="welcome-screen" id="welcomeScreen">
                <img src="{{ url_for('static', filename='icon.png') }}" alt="Nexus" class="welcome-logo"
                    style="width: 80px; height: 80px; border-radius: 50%;">
                <h2>How can I help you today?</h2>
            </div>
        </div>

        <div class="input-area">
            <div class="input-box">
                <textarea id="msgInput" class="input-textarea" placeholder="Send a message..." rows="1"
                    oninput="autoResize(this)" onkeydown="handleKey(event)"></textarea>

                <div class="input-controls">
                    <div class="left-controls">
                        <span class="control-btn" title="Attachments">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M12 5v14M5 12h14" />
                            </svg>
                        </span>
                    </div>

                    <button id="sendBtn" class="send-btn" onclick="sendMessage()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <line x1="12" y1="19" x2="12" y2="5" />
                            <polyline points="5 12 12 5 19 12" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="footer-text">
                Nexus can make mistakes. Consider checking important information.
            </div>
        </div>
    </div>

    <script>
        // --- Logic ---
        marked.setOptions({
            highlight: (code, lang) => hljs.highlightAuto(code).value
        });

        const chatContainer = document.getElementById('chatContainer');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const msgInput = document.getElementById('msgInput');
        const chatList = document.getElementById('chatList');
        const sidebar = document.getElementById('sidebar');
        let currentChatId = null;

        // Init
        window.onload = loadChatList;

        function toggleSidebar() {
            sidebar.classList.toggle('closed');
        }

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 150) + 'px';
        }

        function handleKey(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        // --- Chat Functions ---
        async function loadChatList() {
            const res = await fetch('/chats');
            const data = await res.json();
            chatList.innerHTML = '';
            data.chats.forEach(chat => {
                const el = document.createElement('div');
                el.className = `chat-item ${chat.id === currentChatId ? 'active' : ''}`;
                el.onclick = () => openChat(chat.id);
                el.innerHTML = `
                    ${chat.title}
                    <button class="delete-btn" onclick="deleteChat(event, '${chat.id}')">×</button>
                `;
                chatList.appendChild(el);
            });
        }

        async function openChat(id) {
            currentChatId = id;
            await loadChatList(); // Update active state
            const res = await fetch(`/chat/${id}`);
            const chat = await res.json();

            chatContainer.innerHTML = '';
            welcomeScreen.style.display = 'none'; // Only hide if messages exist? 
            // Actually re-render all
            if (chat.messages && chat.messages.length > 0) {
                chat.messages.forEach(m => renderMessage(m.role, m.content, false));
            } else {
                chatContainer.appendChild(welcomeScreen);
                welcomeScreen.style.display = 'flex';
            }
        }

        function startNewChat() {
            currentChatId = null;
            chatContainer.innerHTML = '';
            chatContainer.appendChild(welcomeScreen);
            welcomeScreen.style.display = 'flex';
            loadChatList();
        }

        async function deleteChat(e, id) {
            e.stopPropagation();
            if (!confirm("Delete?")) return;
            await fetch(`/delete_chat/${id}`, { method: 'DELETE' });
            if (currentChatId === id) startNewChat();
            else loadChatList();
        }

        // --- Render & Stream ---
        function renderMessage(role, text) {
            if (welcomeScreen.parentNode === chatContainer) welcomeScreen.remove();
            const div = document.createElement('div');
            div.className = `message ${role}-message`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'content';

            if (role === 'ai') {
                contentDiv.innerHTML = marked.parse(text);
                contentDiv.querySelectorAll('pre code').forEach(b => hljs.highlightElement(b));
            } else {
                contentDiv.textContent = text;

                // Edit Button for User Messages
                const editBtn = document.createElement('button');
                editBtn.className = 'edit-btn';
                editBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>';
                editBtn.onclick = () => {
                    msgInput.value = text;
                    autoResize(msgInput);
                    msgInput.focus();
                };
                div.appendChild(editBtn);
            }

            div.appendChild(contentDiv);
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return contentDiv;
        }

        let abortController = null; // Control for stopping requests

        async function sendMessage() {
            // Check if we are currently generating -> then STOP
            if (abortController) {
                abortController.abort();
                abortController = null;
                resetSendButton();
                return;
            }

            const text = msgInput.value.trim();
            if (!text) return;

            msgInput.value = '';
            autoResize(msgInput);

            renderMessage('user', text);

            // AI Placeholder
            const aiDiv = document.createElement('div');
            aiDiv.className = 'message ai-message';
            const aiContent = document.createElement('div');
            aiContent.className = 'content';
            aiDiv.appendChild(aiContent);
            chatContainer.appendChild(aiDiv);

            let thoughtDetails = null;
            let markdownBuffer = '';
            let finalContentDiv = document.createElement('div');
            aiContent.appendChild(finalContentDiv);

            // Start Generating State
            setStopButton();
            abortController = new AbortController();

            // Add typing indicator
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = '<span></span><span></span><span></span>';
            aiContent.appendChild(typingIndicator);

            // Render State
            let currentTextDiv = document.createElement('div');
            aiContent.appendChild(currentTextDiv);
            let currentMarkdownBuffer = '';
            let firstContentReceived = false;

            let currentThoughtDetails = null;

            try {
                const res = await fetch('/message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text, chat_id: currentChatId }),
                    signal: abortController.signal
                });

                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); // Incomplete line

                    for (const line of lines) {
                        if (!line.trim()) continue;
                        try {
                            const trimmedLine = line.trim();
                            // Handle concatenated JSONs (e.g. {}{}) - basic retry
                            // Ideally the backend sends one JSON per line, but if they get stuck:
                            if (trimmedLine.startsWith('{') && trimmedLine.includes('}{')) {
                                const splitParts = trimmedLine.split('}{').map((p, i, a) => {
                                    if (i === 0) return p + '}';
                                    if (i === a.length - 1) return '{' + p;
                                    return '{' + p + '}';
                                });
                                splitParts.forEach(p => processEvent(JSON.parse(p)));
                            } else {
                                processEvent(JSON.parse(trimmedLine));
                            }
                        } catch (e) {
                            console.error("JSON Parse Error:", e, line);
                        }
                    }
                }
            } catch (e) {
                if (e.name === 'AbortError') {
                    currentTextDiv.innerHTML += "\n\n*Generation stopped by user.*";
                } else {
                    currentTextDiv.innerText += "\nError connecting.";
                    console.error(e);
                }
            } finally {
                abortController = null;
                resetSendButton();
            }

            // --- Helper to process individual events ---
            function processEvent(event) {
                if (event.type === 'tool_start') {
                    // Remove typing indicator on first content
                    if (typingIndicator.parentNode) typingIndicator.remove();

                    // 1. Finish previous text block (if any)
                    // (Already done by nature of appending)

                    // 2. Create Tool Block (Append to bottom)
                    const details = document.createElement('details');
                    details.className = 'thought-block';
                    details.open = true; // Auto-open for visibility
                    details.innerHTML = `
                                    <summary class="thought-summary">
                                        <svg class="thought-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                                        Process
                                    </summary>
                                    <div class="thought-details"></div>
                                 `;
                    aiContent.appendChild(details);
                    currentThoughtDetails = details.querySelector('.thought-details');

                    // Append Step Info
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'thought-step';
                    stepDiv.innerHTML = `<strong>Using ${event.tool}</strong>...`;
                    currentThoughtDetails.appendChild(stepDiv);

                    // 3. Create NEW Text Block for subsequent output
                    currentTextDiv = document.createElement('div');
                    currentTextDiv.className = 'markdown-content';
                    aiContent.appendChild(currentTextDiv);
                    currentMarkdownBuffer = ''; // Reset buffer for new block
                }
                else if (event.type === 'tool_output') {
                    if (currentThoughtDetails) {
                        const outDiv = document.createElement('div');
                        outDiv.className = 'thought-output';
                        outDiv.innerText = `Result: ${event.output}`;
                        currentThoughtDetails.appendChild(outDiv);
                    }
                }
                else if (event.type === 'thinking') {
                    // Remove typing indicator
                    if (typingIndicator.parentNode) typingIndicator.remove();

                    // Show thinking in a collapsible block
                    if (!currentThoughtDetails) {
                        const details = document.createElement('details');
                        details.className = 'thought-block';
                        details.open = false;
                        details.innerHTML = `
                                        <summary class="thought-summary">
                                            <svg class="thought-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                                            Thinking...
                                        </summary>
                                        <div class="thought-details"></div>
                                     `;
                        aiContent.appendChild(details);
                        currentThoughtDetails = details.querySelector('.thought-details');
                    }
                    currentThoughtDetails.innerHTML += event.content;
                }
                else if (event.type === 'response') {
                    // Remove typing indicator
                    if (typingIndicator.parentNode) typingIndicator.remove();

                    currentMarkdownBuffer += event.content;
                    currentTextDiv.innerHTML = marked.parse(currentMarkdownBuffer);
                    currentTextDiv.querySelectorAll('pre code').forEach(b => hljs.highlightElement(b));
                }
                else if (event.type === 'done') {
                    currentChatId = event.chat_id;
                    loadChatList();
                }
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        function setStopButton() {
            const btn = document.getElementById('sendBtn');
            btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12"/></svg>`; // Square icon
            btn.title = "Stop generating";
        }

        function resetSendButton() {
            const btn = document.getElementById('sendBtn');
            btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>`;
            btn.title = "Send message";
        }

        // --- Proactive Autonomy (SSE) ---
        const evtSource = new EventSource("/stream_updates");
        evtSource.onmessage = function (event) {
            try {
                const data = JSON.parse(event.data);
                if (data.type === 'autonomous_message') {
                    // Start a new thread/block for this
                    // If welcome screen is visible, hide it
                    if (welcomeScreen.parentNode === chatContainer) welcomeScreen.remove();

                    const div = document.createElement('div');
                    div.className = 'message ai-message';

                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'content';
                    div.appendChild(contentDiv);

                    // Add "Impulse" indicator
                    const badge = document.createElement('span');
                    badge.style.cssText = "font-size: 10px; background: #2b2b2b; padding: 2px 6px; border-radius: 4px; color: #888; margin-bottom: 5px; display: inline-block;";
                    badge.innerText = `⚡ Impulse: ${data.reason || 'Spontaneous'}`;
                    contentDiv.appendChild(badge);

                    const textDiv = document.createElement('div');
                    textDiv.className = 'markdown-content';
                    textDiv.innerHTML = marked.parse(data.content);
                    contentDiv.appendChild(textDiv);

                    chatContainer.appendChild(div);
                    chatContainer.scrollTop = chatContainer.scrollHeight;

                    // Update chat list if needed
                    loadChatList();
                }
            } catch (e) {
                console.error("SSE Error:", e);
            }
        };

    </script>
</body>

</html>